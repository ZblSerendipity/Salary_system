<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>工资管理主页</title>
    <link rel="stylesheet" href="css/bootstrap.css"/>
    <link rel="stylesheet" type="text/css" href="../layui/css/layui.css"/>
	<script type="text/javascript" rel="stylesheet" src="../js/jquery-1.12.4.js"></script>
	<script type="text/javascript" rel="stylesheet" src="../js/ajaxUtil.js"></script>
    <script type="text/javascript" src="../layui/layui.js"></script>
	<script type="text/javascript" src="../js/modi_psw.js"></script>

</head>
<body class="layui-layout-body">

<!--顶端导航-->

<div class="layui-layout layui-layout-admin">
    <div class="layui-header">
        <div class="layui-logo ">企业工资管理系统</div>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item" lay-unselect="">
                <a href="javascript:;"><img src="//t.cn/RCzsdCq" class="layui-nav-img"><span id="xm">xingming</span></a>
                <dl class="layui-nav-child">
					<dd><a data-method="notice" id="passwd">&nbsp;修改密码</a></dd>

                </dl>
            </li>
            <!--<li class="layui-nav-item">
                  用户欢迎您！
            </li>-->
            <li class="layui-nav-item"><a href="#" style="text-decoration:none">退出登录</a></li>
        </ul>

    </div>

    <!--侧边栏导航-->
    <div  class="layui-side layui-bg-black">
        <ul class="layui-nav layui-nav-tree layui-inline" lay-filter="demo" style="margin-right: 10px;">
            <li class="layui-nav-item ">
				<a  href="http://localhost:8080/html/mainpage.html">主页</a>
				<dl class="layui-nav-child">
					<dd><a href="http://localhost:8080/html/modifyPage.html">修改信息</a></dd>
				</dl>
            </li>
            <!--工资信息表，奖惩记录，工资数据图展示过去12个月的工资图-->
            <li class="layui-nav-item">
				<a href="http://localhost:8080/html/salaryPage.html">我的工资信息</a>
            </li>
            <li class="layui-nav-item">
				<a  href="http://localhost:8080/html/boardManage.html">公告管理</a>
				<dl class="layui-nav-child">
					<dd><a href="http://localhost:8080/html/boardPage.html">我的公告</a></dd>
				</dl>
            </li>
			<!--管理员工工资，员工信息-->
			<li class="layui-nav-item">
				<a href="http://localhost:8080/html/stuffManagePage.html">员工管理</a>
			</li>
			<!--			财务管理-->
			<li class="layui-nav-item"><a class="layui-this" href="http://localhost:8080/html/salaryManagePage.html">财务管理</a></li>

            <!--角色权限管理-->
            <li class="layui-nav-item"><a href="http://localhost:8080/html/powerPage.html">角色管理</a></li>
        </ul>
    </div>

    <!-- 内容主体区域 -->
    <div class="layui-body" style="background: #F0F0F0; margin-bottom: -45px;">
		<div style="padding: 30px">
			<div class="layui-tab layui-tab-card" >
				<ul class="layui-tab-title">
					<li class="layui-this">财务发放</li>
					<li>财务报表审核</li>


				</ul>
				<div class="layui-tab-content">


					<div class="layui-tab-item layui-show">


						<div style="padding: 10px;">

							<script type="text/html" id="toolbarDemo">
							<div class="layui-btn-group demoTable">
								<button class="layui-btn layui-btn-sm" data-type="getCheckData">按上月发放工资</button>
								<button class="layui-btn layui-btn-sm" data-type="getCheckLength">验证是否全选</button>
							</div>
							</script>
							<table class="layui-hide" id="test" lay-filter="test"></table>
							<script type="text/html" id="barDemo" >
								<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">工资查询</a>
								<a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="add">工资发放</a>
								<a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="ext">福利发放</a>
							</script>

							<div class="demoTable">
								搜索ID：
								<div class="layui-inline">
									<input class="layui-input" name="id" id="demoReload" autocomplete="off">
								</div>
								<button class="layui-btn" data-type="reload">搜索</button>
							</div>
							<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
								<legend>审核单状态表</legend>
							</fieldset>
							<table class="layui-hide" id="auditing-tab" lay-filter="auditing-tab"></table>
						</div>

					</div>
					<div class="layui-tab-item">


						<table class="layui-hide" id="audit_tab" lay-filter="audit_tab"></table>

						<script type="text/html" id="auditDemo">
							<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">详情</a>
							<a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="pass">通过</a>
							<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">退回</a>
						</script>

					</div>

				</div>
			</div>
		</div>


    </div>
</div>

</body>
<script type="text/javascript">


	window.onload = function() {
		ajax({
			method:HTTP_METHOD.POST,
			url:"/Info/getInfo",
			async:true,
			type:HTTP_RESPONSE_TYPE.JSON,
			callback:(data)=>{

				var json = eval(data);
				$("#xm").text(json.uname);

			}
		})
	}
	layui.use('table', function(){
		var table = layui.table;
		table.render({
			elem: '#audit_tab'
			,url: '/financial/aduitTab'
			,cols: [[
				{checkbox: true, fixed: true}
				,{field:'onum', title: '审核单号', width:180, sort: true, fixed: true}
				,{field:'mnum', title: '员工号', sort: true, width:180}
				,{field:'mname', title: '提交财务', width:100}
				,{field:'subtime', title: '时间', width:120,sort: true}
				,{field:'status', title: '审核状态', width:120}
				,{fixed:'right', title: '操作',toolbar: '#auditDemo'}
			]]
			,id: 'auditReload'
			,page: true
			,height: 310
		});

		table.on('tool(audit_tab)', function(obj){
			var data = obj.data;
			var json = eval(data);
			if(obj.event === 'detail'){
				// var absname = json.uname;
				var util = layui.util;
				layer.open({
					type: 1
					,title: '基本工资发放' //不显示标题栏
					,closeBtn: false
					,area: '300px;'
					,shade: 0.8
					,id: 'LAY_layuipro' //设定一个id，防止重复弹出
					,btn: ['登记', '取消']
					,btnAlign: 'c'
					// ,offset:'b'
					,moveType: 1 //拖拽模式，0或者1
					,content:
					,success: function(layero) {

					}
				});



			}else if (obj.event === 'pass') {
				var unum = json.unum;
				var uname = json.uname;
				var util = layui.util;


				layer.open({
					type: 1,
					title: uname + '的缺勤详情', //不显示标题栏
					shadeClose:true,
					area: '500px;',
					shade: 0.8,
					id: 'LAY_layuipro', //设定一个id，防止重复弹出
					btnAlign: 'c',
					anim:2,
					// offset: 'b',
					moveType: 1, //拖拽模式，0或者1,
					content:                   '<div style="padding: 10px; line-height: 22px; background-color: #f2f2f2; color: #fff; font-weight: 300;">' +
							'                    <table class="layui-hide" id="AbsUTab" lay-filter="AbsUTab"></table>' +
							'                    </div>'
					,
					success: function () {

						table.render({
							elem: '#AbsUTab'
							, url: '/stuff/queryAbsByNum'
							,where:{
								unum:unum
							}
							, cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
							, cols: [[
								{field: 'unum', width: '40%', title: 'ID'}
								, {field: 'uname', width: '20%', title: '姓名'}
								, {field: 'date', width: '40%', title: '缺勤日期', sort: true}
							]]
							, page: true
							, limit: 5
						});

					}
				});


			}else if (obj.event === 'del'){

			}
		});

		//财务提交审核进度表
		table.render({
			elem: '#auditing-tab'
			,url: '/financial/aduitTab'
			,cols: [[
				{checkbox: true, fixed: true}
				,{field:'onum', title: '审核单单号', width:150, sort: true, fixed: true}
				,{field:'oname', title: '审核单名', width:120}
				,{field:'mnum', title: '提交者工号', width:150}
				,{field:'status', title: '通过状态', width:120, sort: true}
				,{field:'passnum', title: '通过者工号', width:160}
				,{field:'time', title: '审核时间', sort: true}
				// ,{fixed:'right', title: '操作',toolbar: '#barDemo'}
			]]
			,done:function (res) {
				var json = eval(res);
				for (var i = 0; i < json.length; i++){
					if (json[i].status === "未校验"){
						json[i].time = "未校验"
					}
				}

				console.log(json);
				return json;
			}
			,id: 'auditing-load'
			,page: true
			,height: 310
		});

		//方法级渲染
		table.render({
			elem: '#test'
			,url: '/stuff/getAll'
			,toolbar: '#toolbarDemo'
			,cols: [[
				{checkbox: true, fixed: true}
				,{field:'unum', title: 'ID', width:120, sort: true, fixed: true}
				,{field:'uname', title: '员工名', width:80}
				,{field:'gender', title: '性别', width:80, sort: true}
				,{field:'dname', title: '部门', width:80}
				,{field:'position', title: '职位', width:120}
				,{field:'bankid', title: '银行账号', sort: true, width:150}
				,{field:'basic', title: '工资', sort: true, width:80}
				// ,{field:'date', title: '上次发放时间', width:180}
				,{fixed:'right', title: '操作',toolbar: '#barDemo'}
			]]
			,id: 'testReload'
			,page: true
			// ,height: 310
		});
		//监听toolbar工具条
		table.on('tool(test)', function(obj){
			var data = obj.data;
			var json = eval(data);
			if(obj.event === 'add'){
				// var absname = json.uname;
				var util = layui.util;
				layer.open({
					type: 1
					,title: '基本工资发放' //不显示标题栏
					,closeBtn: false
					,area: '300px;'
					,shade: 0.8
					,id: 'LAY_layuipro' //设定一个id，防止重复弹出
					,btn: ['登记', '取消']
					,btnAlign: 'c'
					// ,offset:'b'
					,moveType: 1 //拖拽模式，0或者1
					,content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;">' +
							'<form class="layui-form" id="change_password">' +
							'<input type="text" name="unum" id="fnum" lay-verify="num" disabled = "disabled" autocomplete="off" placeholder="工号" class="layui-input"  style="color: #000000"><br>'+
							'<input type="text" name="uname" id="fname" lay-verify="name" disabled = "disabled" autocomplete="off" placeholder="姓名" class="layui-input"  style="color: #000000"><br>'+
							'<input type="text" name="basic" id="basic" lay-verify="basic"  autocomplete="off" placeholder="基础工资" class="layui-input"  style="color: #000000"><br>'+
							'<input type="text" name="insurance" id="insurance" lay-verify="insurance"  autocomplete="off" placeholder="五险一金" class="layui-input"  style="color: #000000"><br>'+
							'<input type="text" name="month" id="month" lay-verify="date" autocomplete="off" placeholder="日期选取" class="layui-input"  style="color: #000000"><br>' +
							'<input type="text" name="remark" id="remark" lay-verify="remark" autocomplete="off" placeholder="备注" class="layui-input"  style="color: #000000"><br>' +
							'<br><br>'+
							'</form>' +
							'</div>'
					,success: function(layero) {
						var fnum = json.unum;
						var fname = json.uname;
						$("#fnum").val(fnum);
						$("#fname").val(fname);
						layui.use('laydate', function () {
							var laydate = layui.laydate;

							//常规用法
							laydate.render({
								elem: '#month'
							});
						});
						var btn = layero.find('.layui-layer-btn');
						btn.find('.layui-layer-btn0').click(function () {

							var basic = util.escape($("#basic").val());
							var insurance = util.escape($("#insurance").val());
							var month = util.escape($("#month").val());
							var oname = util.escape($("#remark").val());


							$.ajax({
								type: 'POST',
								url: "/financial/insertStuff",
								data: {unum: fnum, basic: basic, insurance: insurance, month: month,oname:oname},
								success: function (data) {
									if (data == "-1") {
										layer.alert("审核出错！请重新尝试。");
									} else if (data == "-2") {
										layer.alert("添加出错！请重新尝试。");
									} else if (data == "1") {
										layer.alert("工资信息添加成功");
									}
								},
								error: function () {
									layer.alert("添加失败!请尝试重新添加。");
								}
							})

						})
					}
				});



			}else if (obj.event === 'detail') {
				var unum = json.unum;
				var uname = json.uname;
				var util = layui.util;


				layer.open({
					type: 1,
					title: uname + '的缺勤详情', //不显示标题栏
					shadeClose:true,
					area: '500px;',
					shade: 0.8,
					id: 'LAY_layuipro', //设定一个id，防止重复弹出
					btnAlign: 'c',
					anim:2,
					// offset: 'b',
					moveType: 1, //拖拽模式，0或者1,
					content:                   '<div style="padding: 10px; line-height: 22px; background-color: #f2f2f2; color: #fff; font-weight: 300;">' +
							'                    <table class="layui-hide" id="AbsUTab" lay-filter="AbsUTab"></table>' +
							'                    </div>'
					,
					success: function () {

						table.render({
							elem: '#AbsUTab'
							, url: '/stuff/queryAbsByNum'
							,where:{
								unum:unum
							}
							, cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
							, cols: [[
								{field: 'unum', width: '40%', title: 'ID'}
								, {field: 'uname', width: '20%', title: '姓名'}
								, {field: 'date', width: '40%', title: '缺勤日期', sort: true}
							]]
							, page: true
							, limit: 5
						});

					}
				});


			}else if (obj.event === 'ext'){

			}
		});
		var $ = layui.$, active = {
			reload: function(){
				var demoReload = $('#demoReload');

				//执行重载
				table.reload('testReload', {
					page: {
						curr: 1 //重新从第 1 页开始
					}
					,where: {
						key: {
							id: demoReload.val()
						}
					}
				}, 'data');
			}
		};

		$('.demoTable .layui-btn').on('click', function(){
			var type = $(this).data('type');
			active[type] ? active[type].call(this) : '';
		});

		table.on('toolbar(test)', function(obj){
			var checkStatus = table.checkStatus(obj.config.id);
			switch(obj.event){
				case 'getCheckData':
					var data = checkStatus.data;
					layer.alert(JSON.stringify(data));
					break;
				case 'getCheckLength':
					var data = checkStatus.data;
					layer.msg('选中了：'+ data.length + ' 个');
					break;
				case 'isAll':
					layer.msg(checkStatus.isAll ? '全选': '未全选');
					break;

					//自定义头工具栏右侧图标 - 提示
				case 'LAYTABLE_TIPS':
					layer.alert('这是工具栏右侧自定义的一个图标按钮');
					break;
			};
		});
	});


    layui.use('element', function(){
        var element = layui.element;

    });
    
  layui.use('laydate', function(){
  var laydate = layui.laydate;
  
  //常规用法
  laydate.render({
    elem: '#date'
  });
  });
  
  layui.use('form', function(){
  var form = layui.form; //只有执行了这一步，部分表单元素才会自动修饰成功

  form.render();
});   
</script>
</html>